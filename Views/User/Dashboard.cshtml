@using taavoni3.Extention
@using Taavoni.DTOs.Reporting
@model Taavoni.DTOs.Reporting.DashboardDto

<div class="row">
    <!-- Earnings (Monthly) Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            مجموع بدهی</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">$@Model.TotalDebt.ToString("N0")</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Earnings (Monthly) Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            مجموع بدهی بااحتساب جریمه</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">$@Model.TotalDeptWithPenaltyRate.ToString("N0")</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Earnings (Monthly) Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            مجموع پرداختی</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">$@Model.TotalPaid.ToString("N0")</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Earnings (Monthly) Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            مبلغ باقیمانده</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">$@Model.RemainingAmount.ToString("N0")</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>





<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">جزئیات بدهی‌ها</h6>
    </div>
    <div class="card-body">


        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <td>عنوان</td>
                        <td>از تاریخ</td>
                        <td>تا تاریخ</td>
                        <td>تاریخ سررسید</td>
                        <td>مبلغ</td>
                        <td>درصد جریمه</td>
                        <td>مبلغ بااحتساب جریمه</td>
                        <td>مبلغ باقیمانده</td>


                    </tr>
                </thead>
                <tbody>
                    @foreach (var debt in Model.DebtDetails)
                    {
                        <tr>
                            <td>@debt.Title</td>

                            <td>@debt.StartDate.ToPersianDate()</td>
                            <td>@debt.EndDate.ToPersianDate()</td>
                            <td>@(debt.DueDate.ToPersianDate())</td>
                            <td>@debt.Amount.ToString("N0")</td>
                            <td>@debt.PenaltyRate</td>
                            <td>@debt.TotalDeptWithPenaltyRate.ToString("N0")</td>
                            <td>@debt.RemainingAmount.ToString("N0")</td>


                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>






<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">جزئیات پرداخت‌ها </h6>
    </div>
    <div class="card-body">


        <div class="table-responsive">
            <table class="table table-bordered" id="datatable2" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>عنوان</th>
                        <th>مبلغ</th>
                        <th>تاریخ پرداخت</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var payment in Model.PaymentDetails)
                    {
                        <tr>
                            <td>@payment.Title</td>
                            <td>@payment.Amount.ToString("N0")</td>
                           
                            <td>@( payment.PaymentDate.HasValue ? payment.PaymentDate.Value.ToPersianDate() : "تاریخ موجود نیست")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>





<!-- Page Heading -->
<h1 class="h3 mb-4 text-gray-800">Reports</h1>

<div class="row">

    <div class="col-lg-6">
        <!-- نمودار دایره‌ای بدهی‌ها -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">گزارش بدهی‌ها</h6>
            </div>
            <div class="card-body">
                <canvas id="debtChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">گزارش پرداخت ها</h6>
            </div>
            <div class="card-body">
                <canvas id="paymentsChart"></canvas>
            </div>
        </div>
    </div>

</div>


@section Scripts {


    <script>
$(document).ready( function () {
    
    var table = $('#datatable2').DataTable({
        
    });
    
    
} );
        // دریافت داده‌های بدهی‌ها برای چارت
        async function loadDebtChartData() {


            const response = await fetch(`/Reports/api/UserDebts`);
            const data = await response.json();
            // نمایش داده‌ها در کنسول

            const labels = data.map(item => item.userName);

            const remainingDebts = data.map(item => item.remainingDebt);

            const ctx = document.getElementById('debtChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: remainingDebts,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                        hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#f4b619', '#e02d1b'],
                        borderWidth: 1
                    }]
                }
            });
        }

        // بارگذاری چارت‌ها
        $(document).ready(function () {
            loadDebtChartData();
        });




    </script>


    <script>
        fetch('/api/Payments/user-payments')
            .then(response => response.json())
            .then(data => {
                console.log('داده‌های دریافت‌شده از API:', data);

                if (data.length === 0) {
                    alert('هیچ داده‌ای برای نمایش وجود ندارد!');
                    return;
                }
                const labels = data.map(item => item.paymentDate); // برای تاریخ پرداخت
                const amounts = data.map(item => item.amount); // برای مبلغ       

                console.log('Labels:', labels);
                console.log('Amounts:', amounts);

                const ctx = document.getElementById('paymentsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'مجموع پرداختی‌ها',
                            data: amounts,
                            borderColor: [
                                'rgb(255, 99, 132)',
                                'rgb(255, 159, 64)',
                                'rgb(255, 205, 86)',
                                'rgb(75, 192, 192)',
                                'rgb(54, 162, 235)',
                                'rgb(153, 102, 255)',
                                'rgb(201, 203, 207)'
                            ], backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                'rgba(255, 205, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(201, 203, 207, 0.2)'
                            ], borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('خطا در دریافت داده‌ها:', error);
                alert('مشکلی در بارگذاری داده‌ها رخ داده است.');
            });

    </script>
    <!-- Page level plugins -->
    <script src="~/assets/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="~/assets/vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="~/assets/js/demo/datatables-demo.js"></script>
    <script src="~/assets/vendor/chart.js/Chart.min.js"></script>


}
